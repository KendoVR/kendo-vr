<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Untitled</title>
  <script src="https://kendo.cdn.telerik.com/2018.3.911/js/jquery.min.js"></script>
  <script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-animation-component@^4.1.2/dist/aframe-animation-component.min.js"></script> 
  <script src="https://unpkg.com/aframe-debug-cursor-component/dist/aframe-debug-cursor-component.min.js"></script>
  <script src="./kendo-webvr-ddl/aframe-ddl.js"></script>
  <script src="./kendo-webvr-grid/aframe-grid.js"></script>
  <script src="./kendo-webvr-switch/aframe-switch.js"></script>
  <script src="https://kendo.cdn.telerik.com/2018.3.911/js/kendo.all.min.js"></script>
</head>
<body>
  <a-scene>
    <a-entity light="type: ambient; color: #FFF"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.1" position="-0.5 1 1"></a-entity>
    <a-entity id="mouseCursor" cursor="rayOrigin: mouse"></a-entity>

	<!-- CAMERA START -->
    <a-entity position="0 0 250" rotation="0 0 0" id="camera-wrapper">
<!-- MultiView START -->
	<a-entity id="k-view-wrapper" position="-200 500 -600" scale="100 100 100">
		<a-plane class="k-view-button" width="1" height="1" position="0 0 0" src="./assets/view-chart-normal.svg" data-altsvg="./assets/view-chart-selected.svg" data-selected="false" data-hovered="false" data-val="chart-view"></a-plane>
		<a-plane class="k-view-button" width="1" height="1" position="1.5 0 0" src="./assets/view-chart-grid-selected.svg" data-altsvg="./assets/view-chart-grid-normal.svg" data-selected="true" data-hovered="false" data-val="chart-grid-view"></a-plane>
		<a-plane class="k-view-button" width="1" height="1" position="3 0 0" src="./assets/view-grid-normal.svg" data-altsvg="./assets/view-grid-selected.svg" data-selected="false" data-hovered="false" data-val="grid-view"></a-plane>
	</a-entity>
<!-- MultiView END -->

<!-- CAMERA START -->
    <a-entity position="0 0 250" rotation="0 0 0" id="camera-wrapper">
        <a-entity camera="fov: 60; far: 10000" id="camera-entity" look-controls wasd-controls>
            <a-entity cursor="fuse: false;"
                position="0 0 -40"
                geometry="primitive: ring; radiusInner: 0.3; radiusOuter: 0.5"
                material="color: #888; shader: flat">
            </a-entity>
        </a-entity>
	</a-entity>
	<!-- CAMERA END -->
	
	<!-- CHART START -->
	<a-entity id="container" rotation="30 -45 -20" scale="0.7 0.7 0.7"></a-entity>
	<!-- CHART END -->

	<a-cylinder opacity="0.5" transparent="true" height="500" radius="500" repeat="8" position="0 100 0" rotation="0 0 0" open-ended="true" side="double" src="./assets/city_landscape.svg"></a-cylinder>

	<a-plane opacity="0.1" transparent="true" color="gray" height="10000" width="10000" rotation="-90 0 0" position="0 -175 0" side="double" ></a-plane>

	<a-sky color="#eff2f5"></a-sky>

</a-scene>

<!-- MultiView Code START -->
<script>
	window.onload = function(){
		var viewWrapper = document.querySelector("#k-view-wrapper");
		viewWrapper.addEventListener("mouseenter", function(ev){
			if(ev.srcElement.className === "k-view-button" && ev.srcElement.getAttribute("data-selected") === "false" && ev.srcElement.getAttribute("data-hovered") === "false") {
				switchImage(ev.srcElement);
				ev.srcElement.setAttribute("data-hovered", "true");
			}
		});

		viewWrapper.addEventListener("mouseleave", function(ev){
			if(ev.srcElement.className === "k-view-button" && ev.srcElement.getAttribute("data-selected") === "false" && ev.srcElement.getAttribute("data-hovered") === "true") {
				switchImage(ev.srcElement);
				ev.srcElement.setAttribute("data-hovered", "false");
			}
		});

		viewWrapper.addEventListener("click", function(ev){
			if(ev.srcElement.className === "k-view-button" && ev.srcElement.getAttribute("data-selected") === "false") {
				var selectedItem = document.querySelector("[data-selected='true']");
				switchImage(selectedItem);
				ev.srcElement.setAttribute("data-selected", "true");
				ev.srcElement.setAttribute("data-hovered", "false");
				selectedItem.setAttribute("data-selected", "false");

				window.dispatchEvent(new CustomEvent("viewchanged", {detail: {view: ev.srcElement.getAttribute("data-val")}}));
			}
		});
	}

	function switchImage(src) {
		var altSvg = src.getAttribute("data-altsvg");
		src.setAttribute("data-altsvg", src.getAttribute("src"));
		src.setAttribute("src", altSvg);
	}

	window.addEventListener("viewchanged", function (ev) {
		alert(ev.detail.view);
	})
</script>
<!-- MultiView Code end -->

<!-- Chart code -->
<script>
		window.onload = function() {
			var axisNumberingConfigurator = {
				front: {
					x: "0 0 0",
					y: "0 0 0",
					z: "0 0 0"
				},
				right: {
					x: "0 0 0",
					y: "0 90 0",
					z: "-90 0 0"
				},
				back: {
					x: "0 180 0",
					y: "0 180 0",
					z: "0 0 0"
				},
				left: {
					x: "0 0 0",
					y: "0 -90 0",
					z: "-90 180 0"
				},
				top: {
					x: "-90 0 0",
					y: "0 0 0",
					z: "180 -90 -90"
				},
				bottom: {
					x: "90 0 0",
					y: "0 0 0",
					z: "0 -90 -90"
				}
			};

			var colors = [ 
				'#1976d2',
				'#9ab342', 
				'#fff443',
				'#11909f', 
				'#3949ab',
				'#d7d931',
				'#7cb342',
				'#8e24aa',
				'#5e35b1',
				'#8d1269',
				'#00acc1',
				'#7d0f3b',
				'#039be5',
				'#9d0441',
				'#7f32c1',
				'#43a047',
				'#e53935',
				'#c2185b',
				'#fb8c00',
				'#ffb300',
				'#f4511e',
				'#00897b',
				'#c0ca33',
				'#fdd835',
				'#afb42b'
			];

			var navigatorSegmentsConfiguration = [{
				dataNavigation: "90 0 0",
				rotation: "0 0 0",
				dataFront: "top",
				visible: "true"
			},{
				dataNavigation: "0 90 0",
				rotation: "0 0 90",
				dataFront: "left",
				visible: "true"
			},{
				dataNavigation: "-90 0 0",
				rotation: "0 0 180",
				dataFront: "bottom",
				visible: "true"
			},{
				dataNavigation: "0 -90 0",
				rotation: "0 0 -90",
				dataFront: "right",
				visible: "true"
			},{
				dataNavigation: "0 0 0",
				rotation: "90 0 0",
				dataFront: "front",
				visible: "true"
			},{
				dataNavigation: "0 180 0",
				rotation: "90 180 0",
				dataFront: "back",
				visible: "true"
			},{
				dataNavigation: "30 -45 -20",
				rotation: "0 132 55",
				dataFront: "",
				visible: "false"
			},{
				dataNavigation: "-30 -135 -20",
				rotation: "0 -132 55",
				dataFront: ""
			},{
				dataNavigation: "-30 135 20",
				rotation: "0 -48 55",
				dataFront: "",
				visible: "true"
			},{
				dataNavigation: "30 45 20",
				rotation: "0 48 55",
				dataFront: "",
				visible: "true"
			},{
				dataNavigation: "-30 45 -20",
				rotation: "-19 35 126",
				dataFront: "",
				visible: "true"
			},{
				dataNavigation: "-30 -45 20",
				rotation: "-19 118 126",
				dataFront: "",
				visible: "true"
			},{
				dataNavigation: "30 135 -20",
				rotation: "-19 -62 126",
				dataFront: ""
			},{
				dataNavigation: "30 -135 20",
				rotation: "-19 -145 126",
				dataFront: "",
				visible: "true"
			}];

			var loadSingleColorForData = function(color, element) {
				element.setAttribute('color', color);

				// defaultc color: #199cad

				return element;
			}

			var loadMultiColorsForData = function(index, element) {
				element.setAttribute('color', colors[index]);

				return element;
			}

			var loadGreenRedShadingForData = function(item, element) {
				if (item.profit > 0) {
					var profitInMilions = item.profit / 1000000;
					var green = Math.floor(128 + profitInMilions * 8);
					var redAndBlue = Math.floor(128 - profitInMilions * 8);

					element.setAttribute('color', 'rgb(' + redAndBlue + ', ' + green + ', ' + redAndBlue + ')');
				} else {
					var profitInMilions = item.profit / -1000000;
					var red = Math.floor(128 + profitInMilions * 8);
					var greenAndBlue = Math.floor(128 - profitInMilions * 8);

					element.setAttribute('color', 'rgb(' + red + ', ' + greenAndBlue + ', ' + greenAndBlue + ')');
				}

				return element;
			}

			var createTooltipPlane = function(height, position) {
				var plane = document.createElement('a-plane');

				plane.setAttribute('color', '#3f5971');
				plane.setAttribute('material', 'transparent:true; opacity:0.8');
				plane.setAttribute('width', '12');
				plane.setAttribute('height', height);
				plane.setAttribute('position', position);
				
				return plane;
			}

			var createTooltipElements = function() {
				var camera = document.getElementById('camera-entity');
				var header = createTooltipPlane('2.2', '7.5 0 -40');
				var body = createTooltipPlane('6.2', '7.5 -4.2 -40');

				body.setAttribute('visible', 'false');
				body.setAttribute('id', 'extended-tooltip');

				camera.appendChild(header);
				camera.appendChild(body);
			}

			var createAxisLabel = function(position, value, rotation) {
				var axisLabel = document.createElement('a-text');

				axisLabel.setAttribute('width', '150');
				axisLabel.setAttribute('color', '#3f5971');
				axisLabel.setAttribute('position', position);
				axisLabel.setAttribute('value', value);
				axisLabel.setAttribute('rotation', rotation);

				return axisLabel;
			}

			var createNumberStops = function(id, rotation) {
				var numberStops = document.createElement('a-entity');

				numberStops.setAttribute('id', id);
				numberStops.setAttribute('rotation', rotation);

				return numberStops;
			}

			var createSingleStop = function(position, value, rotation) {
				var stop = document.createElement('a-text');

				stop.setAttribute('width', '150');
				stop.setAttribute('color', '#3f5971');
				stop.setAttribute('position', position);
				stop.setAttribute('value', value.toString());
				stop.setAttribute('rotation', rotation);

				return stop;
			}

			var createNumbering = function() {
				var labelsContainer = document.createElement('a-entity');
				var numberStopsX = createNumberStops('number-stops-x', '0 0 0');
				var numberStopsY = createNumberStops('number-stops-y', '0 90 0');
				var numberStopsZ = createNumberStops('number-stops-z', '-90 0 0');

				var axisLabelX = createAxisLabel('79 5 1', 'total income 2017', '0 0 0');
				numberStopsX.appendChild(axisLabelX);

				var axisLabelY = createAxisLabel('-5 100 1', 'profit 2017', '0 0 90');
				numberStopsY.appendChild(axisLabelY);

				var axisLabelZ = createAxisLabel('1 -128 5', 'income change 2017 vs 2016', '0 90 90');
				numberStopsZ.appendChild(axisLabelZ);

				for(var i = -140; i <= 140; i += 20) {
					if (i === 0){
						continue;
					} else {
						var xStop = createSingleStop((i - 6).toString() + ', -3, 1', i, '0 0 0');
						numberStopsX.appendChild(xStop);

						var zStop = createSingleStop('1, ' + (i - 6).toString() + ', -3', i, '0 90 90');
						numberStopsZ.appendChild(zStop);

						var yStop = createSingleStop('3, ' + i.toString() + ', 1', i, '0 0 0');
						numberStopsY.appendChild(yStop);
					}
				}

				labelsContainer.appendChild(numberStopsX);
				labelsContainer.appendChild(numberStopsY);
				labelsContainer.appendChild(numberStopsZ);

				document.getElementById('container').appendChild(labelsContainer);
			}

			var createNavigatorSegment = function(configurationObject) {
				var element = document.createElement('a-sphere');
					
				element.setAttribute('color', '#199cad');
				element.setAttribute('theta-length', '18');
				element.setAttribute('radius', '150');
				element.setAttribute('material', 'side: double; transparent:true; opacity:0.2');
				element.setAttribute('data-navigation', configurationObject.dataNavigation);
				element.setAttribute('rotation', configurationObject.rotation);
				element.setAttribute('data-front', configurationObject.dataFront);
				element.setAttribute('visible', configurationObject.visible);

				return element;
			}

			var createNavigator = function() {
				var navigatorElement = document.createElement('a-entity');

				for(var i = 0; i < navigatorSegmentsConfiguration.length; i ++) {
					var configurationObject = navigatorSegmentsConfiguration[i];
					var element = createNavigatorSegment(configurationObject);

					element.addEventListener('mouseenter', function(e) {
						var segment = e.target;
						segment.setAttribute('material', { side: 'double', transparent: true, opacity: 0.4 });
					});

					element.addEventListener('mouseleave', function(e) {
						var segment = e.target;
						segment.setAttribute('material', { side: 'double', transparent: true, opacity: 0.2 });
					});

					element.addEventListener('click', function(e) {
						var segment = e.target;
						var segments = segment.parentElement.children;
						var navigationPosition = segment.getAttribute('data-navigation');
						var frontPosition = segment.getAttribute('data-front');
						var chart = document.getElementById('container');
						var navigationAnimation = document.createElement('a-animation');
						var scaleAnimation = document.createElement('a-animation');
						var xLabels = document.getElementById('number-stops-x');
						var yLabels = document.getElementById('number-stops-y');
						var zLabels = document.getElementById('number-stops-z');

						for(var i = 0; i < segments.length; i ++) {
							segments[i].setAttribute('visible', 'true');
						}

						segment.setAttribute('visible', 'false');

						navigationAnimation.setAttribute('attribute', 'rotation');
						navigationAnimation.setAttribute('to', navigationPosition);
						navigationAnimation.setAttribute('dur', 1000);

						scaleAnimation.setAttribute('attribute', 'scale');
						scaleAnimation.setAttribute('dur', 1000);

						if (!!frontPosition && frontPosition.length > 0) {
							var newLabelPositions = axisNumberingConfigurator[frontPosition];

							xLabels.setAttribute('visible', 'true');
							yLabels.setAttribute('visible', 'true');
							zLabels.setAttribute('visible', 'true');

							xLabels.setAttribute('rotation', newLabelPositions.x);
							yLabels.setAttribute('rotation', newLabelPositions.y);
							zLabels.setAttribute('rotation', newLabelPositions.z);

							scaleAnimation.setAttribute('to', '0.7 0.7 0.7');
						} else {
							xLabels.setAttribute('visible', 'false');
							yLabels.setAttribute('visible', 'false');
							zLabels.setAttribute('visible', 'false');

							scaleAnimation.setAttribute('to', '0.9 0.9 0.9');
						}

						chart.appendChild(navigationAnimation);
						chart.appendChild(scaleAnimation);
					});

					navigatorElement.appendChild(element);
				}
				
				document.querySelector('#container').appendChild(navigatorElement);
			}

			var generateGrid = function() {
				var container = document.getElementById('container');

				for(var i = -70; i <= 70; i ++) {
					var xy1 = document.createElement('a-entity');
					var xz1 = document.createElement('a-entity');
					var yz1 = document.createElement('a-entity');

					var xy2 = document.createElement('a-entity');
					var xz2 = document.createElement('a-entity');
					var yz2 = document.createElement('a-entity');

					var multiplicator = 2;
					var baseGreatestValue = 70;
					var greatestValue = baseGreatestValue*multiplicator;
					var multiplayedIndex = i*multiplicator;

					if (i === 0) {
						var zMajor = document.createElement('a-cylinder');

						zMajor.setAttribute('radius', '0.2');
						zMajor.setAttribute('height', (greatestValue*multiplicator).toString());
						zMajor.setAttribute('color', '#000');
						zMajor.setAttribute('rotation', '90 0 0');
						container.appendChild(zMajor);

						var yMajor = zMajor.cloneNode(true);
						yMajor.setAttribute('rotation', '0 0 0');
						container.appendChild(yMajor);

						var xMajor = zMajor.cloneNode(true);
						xMajor.setAttribute('rotation', '0 0 90');
						container.appendChild(xMajor);

						var zMajor = document.createElement('a-entity');
						zMajor.setAttribute('height', (greatestValue*multiplicator).toString());
						zMajor.setAttribute('color', '#000');
						zMajor.setAttribute('rotation', '90 0 0');
						container.appendChild(zMajor);
					} else if(i % 10 === 0) {
						xy1.setAttribute('line', {
							start: multiplayedIndex.toString() + ", " + -1*greatestValue + ", 0",
							end: multiplayedIndex.toString() + ", " + greatestValue + ", 0",
							color: "#bbb"
						});

						xz1.setAttribute('line', {
							start: -1*greatestValue.toString() + ", 0, " + multiplayedIndex,
							end: greatestValue.toString() + ", 0, " + multiplayedIndex,
							color: "#bbb"
						});

						yz1.setAttribute('line', {
							start: "0, " + multiplayedIndex + ", -140",
							end: "0, " + multiplayedIndex + ", " + greatestValue,
							color: "#bbb"
						});

						xy2.setAttribute('line', {
							start: -1*greatestValue.toString() + ", " + multiplayedIndex.toString() + ", 0",
							end: greatestValue.toString() + ", " + multiplayedIndex.toString() + ", 0",
							color: "#bbb"
						});

						xz2.setAttribute('line', {
							start: multiplayedIndex.toString() + ", 0, " + -1*greatestValue.toString(),
							end: multiplayedIndex.toString() + ", 0, " + greatestValue.toString(),
							color: "#bbb"
						});

						yz2.setAttribute('line', {
							start: "0, " + -1*greatestValue +", " + multiplayedIndex,
							end: "0, " + greatestValue +", " + multiplayedIndex,
							color: "#bbb"
						});
					}else {
						xy1.setAttribute('line', {
							start: multiplayedIndex.toString() + ", " + -1*greatestValue + ", 0",
							end: multiplayedIndex.toString() + ", " + greatestValue + ", 0",
							color: "#ddd"
						});

						xz1.setAttribute('line', {
							start: -1*greatestValue.toString() + ", 0, " + multiplayedIndex,
							end: greatestValue.toString() + ", 0, " + multiplayedIndex,
							color: "#ccc"
						});

						yz1.setAttribute('line', {
							start: "0, " + multiplayedIndex + ", " + -1*greatestValue,
							end: "0, " + multiplayedIndex + ", " + greatestValue,
							color: "#ddd"
						});

						xy2.setAttribute('line', {
							start: -1*greatestValue.toString() + ", " + multiplayedIndex.toString() + ", 0",
							end: greatestValue.toString() + ", " + multiplayedIndex.toString() + ", 0",
							color: "#ddd"
						});

						xz2.setAttribute('line', {
							start: multiplayedIndex.toString() + ", 0, " + -1*greatestValue,
							end: multiplayedIndex.toString() + ", 0, " + greatestValue,
							color: "#ccc"
						});

						yz2.setAttribute('line', {
							start: "0, " + -1*greatestValue + ", " + multiplayedIndex,
							end: "0, " + greatestValue + ", " + multiplayedIndex,
							color: "#ddd"
						});
					}

					container.appendChild(xy1);
					container.appendChild(xz1);
					container.appendChild(yz1);

					container.appendChild(xy2);
					container.appendChild(xz2);
					container.appendChild(yz2);
				}
			}

			var populateChart = function() {
				var container = document.getElementById('container');

				$.getJSON("./companies-data.json", function(json) {
					for(var i = 0; i < json.data.length; i ++) {
						var item = json.data[i];

						var element = document.createElement('a-sphere');
						var xPoint = item.income / 1000000;
						var yPoint = item.profit / 100000;
						var zPoint = item.incomeChange;
						var position = xPoint.toString() + ' ' + yPoint + ' ' + zPoint.toString();

						element = loadMultiColorsForData(i, element);

						element.setAttribute('position', position );
						element.setAttribute('radius', 0 );
						element.setAttribute('material', 'transparent:true; opacity:0.65');

						for (var name in item) {
							if (item.hasOwnProperty(name)) {
								element.setAttribute('data-' + name, item[name]);
							}
						}

						var animation = document.createElement('a-animation');
						animation.setAttribute('attribute', 'radius');
						animation.setAttribute('to', item.employees / 70);
						animation.setAttribute('dur', 1000);

						element.appendChild(animation);

						element.addEventListener('mouseenter', function(e) {
							var point = e.target;
							var tooltip = document.querySelector('#camera-entity a-plane');

							tooltip.setAttribute('text', {
								color: '#fff',
								value: point.getAttribute('data-company'),
								width: 20 * 1.5,
								xOffset: 21 / 2 - 0.8
							});

							tooltip.setAttribute('visible', 'true');

							point.setAttribute('material', 'transparent:true; opacity:1');
						});

						element.addEventListener('mouseleave', function(e) {
							var point = e.target;
							var tooltip = document.querySelector('#camera-entity a-plane');
							var extendedTooltip = document.querySelector('#extended-tooltip');

							tooltip.setAttribute('visible', 'false');
							extendedTooltip.setAttribute('visible', 'false');

							point.setAttribute('material', 'transparent:true; opacity:0.7');
						});

						element.addEventListener('click', function(e) {
							var point = e.target;
							var extendedTooltip = document.querySelector('#extended-tooltip');

							extendedTooltip.setAttribute('text', {
								color: '#fff',
								value: 'employees: ' + point.getAttribute('data-employees') + '\n' +
									   'income: ' + kendo.toString(Number(point.getAttribute('data-income')), 'c0') + '\n' +
									   'income change: ' + point.getAttribute('data-incomeChange') + '%' + '\n' +
									   'profit: ' + kendo.toString(Number(point.getAttribute('data-profit')), 'c0'),
								width: 14 * 1.5,
								xOffset: 12/2 - 0.8,
								lineHeight: 60
							});

							extendedTooltip.setAttribute('visible', 'true');
						});

						container.appendChild(element);
					}
				});
			}

			generateGrid();
			createNavigator();
			createNumbering();
			populateChart();
			createTooltipElements();
		}
	</script>
</body>
</html>